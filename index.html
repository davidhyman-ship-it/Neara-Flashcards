
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Neara Flashcards — Live from Google Sheets (CSV)</title>
<style>
  html, body { margin:0; padding:0; height:100%; background:#0b0b0f; color:#eaeaea; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; }
  .container { min-height:100%; display:flex; flex-direction:column; gap:16px; align-items:center; padding:20px; }
  .header { width:min(1100px, 92vw); display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .title { font-weight:700; letter-spacing:.2px; font-size:20px; opacity:.95 }
  .controls { display:flex; gap:8px; flex-wrap:wrap; }
  button { background:#1d1d25; color:#eaeaea; border:1px solid #2a2a35; padding:10px 14px; border-radius:12px; cursor:pointer; }
  button:hover { background:#262635; }
  .pill { font-size:12px; padding:6px 10px; border-radius:999px; background:#14141b; border:1px solid #2a2a35; cursor:pointer; }
  .pill.active { background:white; color:#0b0b0f; border-color:transparent; }
  .deck-info { font-size:12px; opacity:.7 }
  .stage { flex:1; display:flex; align-items:center; justify-content:center; width:100%; }
  .card-outer { perspective: 1200px; }
  .card { width:min(880px, 92vw); height:min(520px, 60vh); border-radius:20px; position:relative; transform-style:preserve-3d; transition:transform .5s ease-in-out; cursor:pointer; box-shadow:0 20px 60px rgba(0,0,0,.5); }
  .face { position:absolute; inset:0; background:#fff; color:#000; border-radius:20px; display:flex; align-items:center; justify-content:center; text-align:center; padding:28px; backface-visibility:hidden; }
  .face h2 { font-size: clamp(18px, 3vw, 28px); line-height:1.25; font-weight:650; }
  .face p { font-size: clamp(14px, 2.1vw, 20px); line-height:1.42; }
  .back { transform:rotateY(180deg); font-weight:600; }
  .foot { width:min(1100px, 92vw); display:flex; flex-direction:column; gap:10px; }
  .categories { display:flex; gap:8px; flex-wrap:wrap; }
  .progress { font-size:12px; opacity:.7 }
  .badge { font-size:11px; padding:4px 8px; border:1px solid #2a2a35; border-radius:999px; opacity:.8; }
  .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .kbd { padding:1px 6px; border:1px solid #2a2a35; border-radius:6px; font-size:12px; background:#12121a; }
  .muted { color:#b7b7c9; opacity:.8 }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">Neara Flashcards — Live from Google Sheets</div>
    <div class="controls">
      <button id="btnPrev">◀ Prev</button>
      <button id="btnFlip">Flip (Space)</button>
      <button id="btnNext">Next ▶</button>
      <button id="btnRandom">Random</button>
      <button id="btnQuiz">Quiz Mode</button>
      <button id="btnExport">Export JSON</button>
    </div>
  </div>
  <div class="deck-info" id="deckInfo">Loading cards…</div>

  <div class="stage">
    <div class="card-outer">
      <div class="card" id="card">
        <div class="face front" id="front"><div><div class="badge" id="catBadge"></div><h2 id="question"></h2></div></div>
        <div class="face back" id="back"><div><div class="badge" id="catBadgeBack"></div><p id="answer"></p></div></div>
      </div>
    </div>
  </div>

  <div class="foot">
    <div class="toolbar">
      <span class="muted">Filter by category:</span>
      <div class="categories" id="categories"></div>
    </div>
    <div class="progress" id="progress"></div>
    <div class="muted">Tip: click the card or press <span class="kbd">Space</span> to flip. Use <span class="kbd">←</span>/<span class="kbd">→</span> for prev/next, <span class="kbd">R</span> for random.</div>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1JObO5eJ27zXHHPVaC3wp-6B2qa0XDsojMn_W3Cx1ls0/gviz/tq?tqx=out:csv&gid=519835157";

// Lightweight CSV parser that handles quotes and commas
function parseCSV(text){
  const rows = [];
  let cur = [], val = '', inQuotes = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (inQuotes){
      if (c === '"' && n === '"'){ val += '"'; i++; }
      else if (c === '"'){ inQuotes = false; }
      else { val += c; }
    } else {
      if (c === '"'){ inQuotes = true; }
      else if (c === ','){ cur.push(val); val=''; }
      else if (c === '\n'){ cur.push(val); rows.push(cur); cur=[]; val=''; }
      else if (c === '\r'){ /* ignore */ }
      else { val += c; }
    }
  }
  if (val.length>0 || cur.length>0) { cur.push(val); rows.push(cur); }
  return rows;
}

let allCards = [];
let filtered = [];
let idx = 0;
let flipped = false;
let currentCategory = "All";
let quizActive=false, quizIdx=0, quizQns=[], score=0;

const cardEl = document.getElementById('card');
const qEl = document.getElementById('question');
const aEl = document.getElementById('answer');
const catEl = document.getElementById('catBadge');
const catBackEl = document.getElementById('catBadgeBack');
const progressEl = document.getElementById('progress');
const deckInfoEl = document.getElementById('deckInfo');
const catsEl = document.getElementById('categories');

function uniqueCategories(cards){ return Array.from(new Set(cards.map(c=>c.category))).sort(); }

function renderCategories(){
  catsEl.innerHTML = '';
  const cats = ['All', ...uniqueCategories(allCards)];
  cats.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'pill' + (c===currentCategory ? ' active' : '');
    btn.textContent = c;
    btn.onclick = () => { currentCategory = c; applyFilter(); };
    catsEl.appendChild(btn);
  });
}

function applyFilter(){
  filtered = currentCategory==='All' ? [...allCards] : allCards.filter(c => c.category===currentCategory);
  idx = 0; flipped = false; update(); renderCategories();
}

function update(){
  if(filtered.length===0){
    qEl.textContent = "No cards loaded.";
    aEl.textContent = "Check sheet headers (category | question | answer) and sharing permissions.";
    catEl.textContent = currentCategory;
    catBackEl.textContent = currentCategory;
    cardEl.style.transform = 'rotateY(0deg)';
    progressEl.textContent = '';
    return;
  }
  const c = filtered[idx];
  qEl.textContent = c.q;
  aEl.textContent = c.a;
  catEl.textContent = c.category;
  catBackEl.textContent = c.category;
  cardEl.style.transform = flipped ? 'rotateY(180deg)' : 'rotateY(0deg)';
  progressEl.textContent = `Card ${idx+1} / ${filtered.length} (${currentCategory})`;
  deckInfoEl.textContent = `${allCards.length} total cards • ${uniqueCategories(allCards).length} categories`;
}

function prev(){ idx = (idx-1+filtered.length)%filtered.length; flipped=false; update(); }
function next(){ idx = (idx+1)%filtered.length; flipped=false; update(); }
function flip(){ flipped=!flipped; update(); }
function random(){ if(filtered.length<=1) return; let r=Math.floor(Math.random()*filtered.length); if(r===idx) r=(r+1)%filtered.length; idx=r; flipped=false; update(); }

// Quiz mode
function startQuiz(){
  if(filtered.length<4){ alert('Need at least 4 cards in the current set for a quiz.'); return; }
  quizActive=true; quizIdx=0; score=0;
  const pool=[...filtered];
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()* (i+1)); [pool[i],pool[j]]=[pool[j],pool[i]];}
  quizQns = pool.slice(0, Math.min(10, pool.length)).map(card => {
    const answers = [card.a];
    const others = allCards.filter(c=>c!==card).map(c=>c.a);
    for(let i=others.length-1;i>0;i--){const j=Math.floor(Math.random()* (i+1)); [others[i],others[j]]=[others[j],others[i]];}
    answers.push(...others.slice(0,3));
    for(let i=answers.length-1;i>0;i--){const j=Math.floor(Math.random()* (i+1)); [answers[i],answers[j]]=[answers[j],answers[i]];}
    return {q: card.q, a: card.a, category: card.category, options: answers};
  });
  renderQuizQuestion();
}

function renderQuizQuestion(){
  const item = quizQns[quizIdx];
  flipped=false;
  cardEl.style.transform = 'rotateY(0deg)';
  qEl.innerHTML = item.q + "<br><br><span style='font-size:13px;opacity:.7'>(Choose one below)</span>";
  aEl.textContent = "";
  catEl.textContent = "Quiz • " + item.category;
  catBackEl.textContent = "Quiz • " + item.category;
  renderOptions(item);
  progressEl.textContent = `Quiz question ${quizIdx+1} / ${quizQns.length} • Score: ${score}`;
}

let optionsBar=null;
function renderOptions(item){
  removeOptions();
  optionsBar = document.createElement('div');
  optionsBar.style.marginTop = '14px';
  optionsBar.style.display = 'flex';
  optionsBar.style.gap = '8px';
  optionsBar.style.flexWrap = 'wrap';
  document.querySelector('.foot').prepend(optionsBar);
  item.options.forEach(opt => { 
    const b=document.createElement('button');
    b.textContent = opt.length>160 ? opt.slice(0,157)+'…' : opt;
    b.onclick = ()=>{ 
      if(opt===item.a) { score++; }
      quizIdx++;
      if(quizIdx>=quizQns.length) { endQuiz(); } else { renderQuizQuestion(); }
    };
    optionsBar.appendChild(b);
  });
}

function removeOptions(){ if(optionsBar && optionsBar.parentNode){ optionsBar.parentNode.removeChild(optionsBar); } optionsBar=null; }

function endQuiz(){
  quizActive=false;
  removeOptions();
  qEl.textContent = `Quiz complete! Score: ${score} / ${quizQns.length}`;
  aEl.textContent = "Click Next or Random to keep studying, or start another quiz.";
  catEl.textContent = "Quiz";
  catBackEl.textContent = "Quiz";
  progressEl.textContent = `Quiz complete • Score: ${score} / ${quizQns.length}`;
}

// Export
document.getElementById('btnExport').onclick = ()=>{ 
  const blob = new Blob([JSON.stringify(allCards, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='neara_flashcards.json'; a.click(); URL.revokeObjectURL(url);
};

// Navigation
document.getElementById('btnPrev').onclick = ()=> quizActive ? null : prev();
document.getElementById('btnNext').onclick = ()=> quizActive ? null : next();
document.getElementById('btnFlip').onclick = ()=> quizActive ? null : flip();
document.getElementById('btnRandom').onclick = ()=> quizActive ? null : random();
document.getElementById('btnQuiz').onclick = ()=> startQuiz();
cardEl.addEventListener('click', ()=>{ if(!quizActive) flip(); });
window.addEventListener('keydown', (e)=>{ 
  if(e.key===' '){ e.preventDefault(); if(!quizActive) flip(); }
  else if(e.key==='ArrowRight'){ if(!quizActive) next(); }
  else if(e.key==='ArrowLeft'){ if(!quizActive) prev(); }
  else if(e.key.toLowerCase()==='r'){ if(!quizActive) random(); }
});

// Load CSV
(async function loadCSV(){
  try{
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) throw new Error('Empty CSV');
    const header = rows[0].map(h => (h||'').toString().trim().toLowerCase());
    const ci = header.indexOf('category');
    const qi = header.indexOf('question');
    const ai = header.indexOf('answer');
    const cards = [];
    for (let i=1;i<rows.length;i++){
      const r = rows[i];
      const cat = (r[ci]||'').toString().trim();
      const q = (r[qi]||'').toString().trim();
      const a = (r[ai]||'').toString().trim();
      if (cat && q && a) cards.push({category:cat, q:q, a:a});
    }
    allCards = cards;
    currentCategory = "All";
    applyFilter();
  }catch(e){
    deckInfoEl.textContent = "Failed to load CSV. Check sharing permissions and try again.";
    allCards = []; applyFilter();
  }
})();
</script>
</body>
</html>
